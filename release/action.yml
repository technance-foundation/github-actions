name: Release (Changesets + pnpm)
description: >
    Reusable composite action to build and release packages using pnpm and Changesets.
    Handles checkout, Node/pnpm setup, install, build, version capture, publish, and optional PR back to main.

branding:
    icon: package
    color: blue

inputs:
    # Git / Branch / Checkout
    fetch-depth:
        description: "Checkout fetch depth"
        default: "0"
        required: false
    ref:
        description: "Ref to checkout"
        default: "${{ github.ref }}"
        required: false

    # Node / pnpm
    node-version-file:
        description: "Path to .nvmrc; ignored if node-version is provided"
        default: ".nvmrc"
        required: false
    node-version:
        description: "Explicit Node.js version (overrides node-version-file)"
        required: false
    pnpm-version:
        description: "pnpm version to install"
        default: "9.0.6"
        required: false
    cache:
        description: "Cache strategy for setup-node (pnpm|npm|yarn|false)"
        default: "pnpm"
        required: false

    # Registry / Auth
    npm-registry:
        description: "NPM registry URL"
        default: "https://registry.npmjs.org"
        required: false
    npm-token:
        description: "NPM token for authentication (optional)"
        required: false

    # Commands
    install-command:
        description: "Dependency install command"
        default: "pnpm install --frozen-lockfile"
        required: false
    build-command:
        description: "Build command"
        default: "pnpm build"
        required: false
    version-command:
        description: "Changesets version command"
        default: "pnpm run bump"
        required: false
    publish-command:
        description: "Publish command"
        default: "pnpm run release"
        required: false

    # Changesets behavior
    use-changesets:
        description: "Use changesets/action@v1 for versioning & publish"
        default: "true"
        required: false
    changesets-title:
        description: "Release PR title"
        default: "Release"
        required: false
    changesets-commit:
        description: "Release PR commit message"
        default: "Release"
        required: false

    # Changesets base branch
    changesets-base-branch:
        description: "Base branch for changesets to fetch and compare against (usually main/master)"
        default: "main"
        required: false

    # PR back to base branch after publish
    open-pr-to-base:
        description: "Open a PR from release branch back to base after a successful publish"
        default: "true"
        required: false
    pr-base:
        description: "Target branch to merge the release branch into (e.g. main for production releases, next for pre-releases)"
        default: "main"
        required: false
    pr-title:
        description: "Title for the back-merge PR"
        default: ""
        required: false
    pr-body:
        description: "Body for the back-merge PR"
        default: "Auto-generated after publishing."
        required: false
    auto-merge:
        description: "Automatically squash merge the back-merge PR using admin privileges (requires open-pr-to-base: true and admin access)"
        default: "true"
        required: false

    # Misc
    working-directory:
        description: "Working directory to run all commands in"
        required: false
    continue-on-empty-changesets:
        description: "Skip version capture gracefully when no changesets exist"
        default: "true"
        required: false

outputs:
    published:
        description: "Whether a publish occurred (from changesets/action)"
        value: ${{ steps.maybe-changesets.outputs.published }}
    new_version:
        description: "Captured new version from Changesets status (if any)"
        value: ${{ steps.capture-version.outputs.new_version }}
    prepare_title:
        description: "Title for the prepare/version PR (e.g. 'Prepare release `@scope/pkg@1.0.0`')"
        value: ${{ steps.capture-version.outputs.prepare_title }}
    release_title:
        description: "Title for the back-merge PR (e.g. 'Publish `@scope/pkg@1.0.0`')"
        value: ${{ steps.release-title.outputs.release_title }}
    release_count:
        description: "Number of packages in this release"
        value: ${{ steps.release-title.outputs.package_count }}
    pr_url:
        description: "URL of the PR opened back to base (if created)"
        value: ${{ steps.open-pr.outputs.pr_url }}

runs:
    using: "composite"
    steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
              fetch-depth: ${{ inputs.fetch-depth }}
              ref: ${{ inputs.ref }}

        - name: Setup git for Changesets
          shell: bash
          run: |
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              git config --global user.name "github-actions[bot]"
              git fetch origin ${{ inputs.changesets-base-branch }}:${{ inputs.changesets-base-branch }}

        - name: Setup pnpm
          uses: pnpm/action-setup@v4
          with:
              version: ${{ inputs.pnpm-version }}
              run_install: false

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: ${{ inputs.node-version }}
              node-version-file: ${{ inputs.node-version == '' && inputs.node-version-file || '' }}
              registry-url: ${{ inputs.npm-registry }}
              cache: ${{ inputs.cache }}
              cache-dependency-path: |
                  **/pnpm-lock.yaml

        - name: Authenticate NPM registry (optional)
          if: ${{ inputs.npm-token != '' }}
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          env:
              NPM_TOKEN: ${{ inputs.npm-token }}
          run: |
              echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

        - name: Install dependencies
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: ${{ inputs.install-command }}

        - name: Build packages
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: ${{ inputs.build-command }}

        - name: Capture New Release Version
          id: capture-version
          if: ${{ inputs.use-changesets == 'true' && ( inputs.continue-on-empty-changesets == 'true' || hashFiles('.changeset/*.md') != '' ) }}
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              set -e
              if ! command -v jq >/dev/null 2>&1; then
                sudo apt-get update -y && sudo apt-get install -y jq
              fi

              if pnpm changeset status --output=release.json 2>/dev/null; then
                # Count how many packages are being released
                RELEASE_COUNT="$(jq -r '.releases | length' release.json)"
                
                if [ "$RELEASE_COUNT" -eq 1 ]; then
                  # Single package: "Prepare release `@scope/pkg@version`"
                  PKG_NAME="$(jq -r '.releases[0].name // empty' release.json)"
                  PKG_VERSION="$(jq -r '.releases[0].newVersion // empty' release.json)"
                  PREPARE_TITLE="Prepare release \`${PKG_NAME}@${PKG_VERSION}\`"
                elif [ "$RELEASE_COUNT" -gt 1 ]; then
                  # Multiple packages
                  PREPARE_TITLE="Prepare new releases"
                else
                  PREPARE_TITLE="Prepare release"
                fi

                NEW_VERSION="$(jq -r '.releases[0].newVersion // empty' release.json)"
                echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"
                echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
                echo "prepare_title=$PREPARE_TITLE" >> "$GITHUB_OUTPUT"
                rm -f release.json
              else
                echo "NEW_VERSION=" >> "$GITHUB_ENV"
                echo "new_version=" >> "$GITHUB_OUTPUT"
                echo "prepare_title=Prepare release" >> "$GITHUB_OUTPUT"
              fi

        - name: Create Release PR or Publish (Changesets)
          id: maybe-changesets
          if: ${{ inputs.use-changesets == 'true' }}
          uses: changesets/action@v1
          with:
              title: ${{ steps.capture-version.outputs.prepare_title }}
              commit: ${{ steps.capture-version.outputs.prepare_title }}
              version: ${{ inputs.version-command }}
              publish: ${{ inputs.publish-command }}
          env:
              GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
              NPM_TOKEN: ${{ env.NPM_TOKEN }}
              NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}

        - name: Generate release title from published packages
          id: release-title
          if: ${{ steps.maybe-changesets.outputs.published == 'true' }}
          shell: bash
          run: |
              set -e
              PUBLISHED='${{ steps.maybe-changesets.outputs.publishedPackages }}'

              # Count published packages
              PKG_COUNT="$(echo "$PUBLISHED" | jq -r 'length')"

              if [ "$PKG_COUNT" -eq 1 ]; then
                # Single package: "Publish `@scope/pkg@version`"
                PKG_NAME="$(echo "$PUBLISHED" | jq -r '.[0].name')"
                PKG_VERSION="$(echo "$PUBLISHED" | jq -r '.[0].version')"
                RELEASE_TITLE="Publish \`${PKG_NAME}@${PKG_VERSION}\`"
              elif [ "$PKG_COUNT" -gt 1 ]; then
                # Multiple packages
                RELEASE_TITLE="Publish new releases"
              else
                RELEASE_TITLE="Publish"
              fi

              echo "release_title=$RELEASE_TITLE" >> "$GITHUB_OUTPUT"
              echo "package_count=$PKG_COUNT" >> "$GITHUB_OUTPUT"

        - name: Merge release â†’ ${{ inputs.pr-base }}
          id: open-pr
          if: ${{ inputs.open-pr-to-base == 'true' && steps.maybe-changesets.outputs.published == 'true' }}
          shell: bash
          run: |
              set -e
              : "${GH_TOKEN:=${GITHUB_TOKEN}}"
              : "${GH_TOKEN:?GH_TOKEN/GITHUB_TOKEN required}"

              # Use pr-title input if provided, otherwise use the release title from published packages
              input_title="${{ inputs.pr-title }}"
              if [ -z "${input_title}" ]; then
                input_title="${{ steps.release-title.outputs.release_title }}"
              fi
              # Final fallback
              if [ -z "${input_title}" ]; then
                input_title="Publish"
              fi

              # Create the PR
              pr_url="$(gh pr create \
                --head "${{ github.ref_name }}" \
                --base "${{ inputs.pr-base }}" \
                --title "${input_title}" \
                --body "${{ inputs.pr-body }}" \
                --repo "${{ github.repository }}" \
                --fill --no-maintainer-edit)"

              echo "pr_url=${pr_url}" >> "$GITHUB_OUTPUT"

              # Squash merge immediately using admin privileges (bypasses branch protection)
              if [ "${{ inputs.auto-merge }}" == "true" ]; then
                gh pr merge "$pr_url" --squash --admin --delete-branch
              fi
          env:
              GH_TOKEN: ${{ env.GITHUB_TOKEN }}
              GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
